name: Deploy to GitHub Pages
on:
  # Trigger on PRs to master
  pull_request:
    branches:
      - master
  # Trigger on pushes to master
  push:
    branches:
      - master
  # Manual trigger
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write
  pull-requests: write

jobs:
  # For PRs, we build with PR-specific configuration
  build-pr:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          npm install terser --save-dev

      # Configure vite.config.js for PR
      - name: Update vite.config.js
        run: |
          PR_NUMBER="${{ github.event.number }}"
          # Create a backup of the original config
          cp vite.config.js vite.config.original.js

          # Modify base path for PR
          if grep -q "base:" vite.config.js; then
            sed -i "s|base:.*|base: '/otzarot-game/',|" vite.config.js
          else
            sed -i "/defineConfig/a\\  base: '/otzarot-game/'," vite.config.js
          fi

          echo "Modified vite.config.js:"
          cat vite.config.js

      - name: Build
        run: |
          PR_NUMBER="${{ github.event.number }}"
          VITE_PR_NUMBER=${PR_NUMBER} \
          VITE_APP_ENV=staging \
          VITE_COMMIT_SHA=$(git rev-parse HEAD) \
          npm run build

          # Create a 404.html file for client-side routing
          cp dist/index.html dist/404.html

          # Add a PR banner to the top of the page to clearly identify this as a PR preview
          # This injects a banner at the start of the body
          sed -i 's/<body>/<body><div style="position:fixed; top:0; left:0; right:0; background-color:#ff6700; color:white; text-align:center; padding:8px; z-index:9999; font-size:16px; font-weight:bold; font-family:sans-serif;">PR PREVIEW #'${PR_NUMBER}' - This is not production<\/div>/' dist/index.html
          sed -i 's/<body>/<body><div style="position:fixed; top:0; left:0; right:0; background-color:#ff6700; color:white; text-align:center; padding:8px; z-index:9999; font-size:16px; font-weight:bold; font-family:sans-serif;">PR PREVIEW #'${PR_NUMBER}' - This is not production<\/div>/' dist/404.html

      - name: Upload PR build artifact
        uses: actions/upload-artifact@v4
        with:
          name: pr-build
          path: dist
          retention-days: 1

  # For pushes to master, build with production config
  build-production:
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          npm install terser --save-dev

      # Ensure vite.config.js has the correct configuration
      - name: Update vite.config.js
        run: |
          # Create a backup of the original config
          cp vite.config.js vite.config.original.js

          # Update base path
          if grep -q "base:" vite.config.js; then
            sed -i "s|base:.*|base: '/otzarot-game/',|" vite.config.js
          else
            sed -i "/defineConfig/a\\  base: '/otzarot-game/'," vite.config.js
          fi

          echo "Modified vite.config.js:"
          cat vite.config.js

      - name: Build
        run: |
          VITE_APP_ENV=production \
          VITE_COMMIT_SHA=$(git rev-parse HEAD) \
          npm run build

          # Create a 404.html file for client-side routing
          cp dist/index.html dist/404.html

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload production build artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # Deploy PR build to GitHub Pages
  deploy-pr:
    needs: build-pr
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Download PR build artifact
        uses: actions/download-artifact@v4
        with:
          name: pr-build
          path: dist

      # Setup GitHub Pages
      - name: Setup Pages
        uses: actions/configure-pages@v4

      # Upload pages artifact (this is different from uploading to a branch)
      - name: Upload PR build as pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist

      # Deploy to GitHub Pages
      - name: Deploy PR build to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      # Add comment to PR with deployment URL
      - name: Find Comment
        uses: peter-evans/find-comment@v2
        id: find-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: PR Preview Deployment

      - name: Create or update comment
        uses: peter-evans/create-or-update-comment@v3
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ðŸš€ PR Preview Deployment is ready!

            Visit PR Preview (#${{ github.event.number }}): ${{ steps.deployment.outputs.page_url }}

            This preview temporarily replaces the production deployment but will display an orange banner 
            at the top to clearly identify it as a PR preview.

            The production deployment will be restored when this PR is merged or closed.
          edit-mode: replace
