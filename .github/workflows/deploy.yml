name: Deploy to GitHub Pages
on:
  # Trigger on PRs to master
  pull_request:
    branches:
      - master
  # Trigger on pushes to master
  push:
    branches:
      - master
  # Manual trigger
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write
  pull-requests: write

jobs:
  # Main production build and deployment
  build-and-deploy-production:
    runs-on: ubuntu-latest
    # Only run production deployment on push to master or manual trigger
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          npm install terser --save-dev

      - name: Build production
        run: |
          NODE_ENV=production \
          VITE_BASE_PATH=/otzarot-game/ \
          VITE_APP_ENV=production \
          VITE_COMMIT_SHA=$(git rev-parse HEAD) \
          npm run build

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload production artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # PR preview build
  build-pr-preview:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          npm install terser --save-dev

      - name: Build PR preview
        run: |
          STAGING_PATH="/otzarot-game/pr-${{ github.event.number }}"
          echo "Building PR #${{ github.event.number }} with base path: $STAGING_PATH"

          NODE_ENV=development \
          VITE_BASE_PATH=$STAGING_PATH \
          VITE_APP_ENV=staging \
          VITE_PR_NUMBER=${{ github.event.number }} \
          VITE_COMMIT_SHA=$(git rev-parse HEAD) \
          npm run build

          # Create a dedicated index.html in the PR directory
          echo "PR Preview build complete. Directory contents:"
          ls -la dist/

      - name: Deploy PR preview to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: dist
          branch: gh-pages
          target-folder: pr-${{ github.event.number }}
          clean: true

      - name: Comment on PR with preview link
        uses: mshick/add-pr-comment@v2
        with:
          message: |
            ðŸš€ PR Preview Deployment is ready!

            Visit PR Preview (#${{ github.event.number }}): https://relbns.github.io/otzarot-game/pr-${{ github.event.number }}/

            Visit Production: https://relbns.github.io/otzarot-game/
